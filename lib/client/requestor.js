// Generated by CoffeeScript 1.6.3
var count, extend, parallel, promised, queue, requestor, sequence, transport, _ref;

_ref = require('../support'), extend = _ref.extend, promised = _ref.promised;

queue = require('./queue').queue;

transport = require('./transport').transport;

sequence = require('when/sequence');

parallel = require('when/parallel');

count = 0;

requestor = void 0;

exports.testable = function() {
  return requestor;
};

exports.requestor = extend(queue, function(superclass, config) {
  var api;
  if (config == null) {
    config = {};
  }
  requestor = {
    superclass: superclass,
    transport: transport(config),
    request: promised(function(action, opts, result) {
      var notify, reject, resolve;
      resolve = action.resolve, reject = action.reject, notify = action.notify;
      return sequence([
        function() {
          return superclass.enqueue({
            opts: opts,
            promise: result
          });
        }, function() {
          return superclass.dequeue();
        }
      ]).then(function(_arg) {
        var NULL, request, requests;
        NULL = _arg[0], requests = _arg[1];
        console.log({
          PROCESS: requests,
          COUNT: count++
        });
        return parallel((function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = requests.length; _i < _len; _i++) {
            request = requests[_i];
            _results.push((function(request) {
              return function() {
                return requestor.transport.request(request.opts, request.sequence, request.promise);
              };
            })(request));
          }
          return _results;
        })()).then(resolve, reject, notify);
      }, reject, notify);
    })
  };
  return api = {
    request: requestor.request
  };
});
