// Generated by CoffeeScript 1.6.3
var HttpRequest, deferred, testable;

deferred = require('../support').deferred;

HttpRequest = require('./http_request');

testable = void 0;

exports._authenticator = function() {
  return testable;
};

exports.Authenticator = function(config, queue) {
  var api, authenticator;
  config || (config = {});
  authenticator = {
    queue: queue,
    authenticating: 0,
    scheme: void 0,
    type: void 0,
    assign: function() {
      var error, modulePath;
      if (config.authenticator.module == null) {
        return false;
      }
      if (authenticator.scheme != null) {
        return true;
      }
      try {
        modulePath = "" + config.authenticator.module;
        authenticator.scheme = require(modulePath)(config);
      } catch (_error) {
        error = _error;
        try {
          modulePath = "./authenticators/" + config.authenticator.module;
          authenticator.scheme = require(modulePath)(config);
        } catch (_error) {}
      }
      try {
        authenticator.type = authenticator.scheme.type;
      } catch (_error) {}
      return authenticator.scheme != null;
    },
    configured: function() {
      return (config.authenticator != null) && authenticator.assign();
    },
    requestAuth: function(httpRequest) {
      var error;
      try {
        authenticator.scheme.requestAuth(httpRequest);
        return true;
      } catch (_error) {
        error = _error;
        try {
          error.detail = {
            request: httpRequest.opts
          };
        } catch (_error) {}
        httpRequest.promised.reject(error);
        return false;
      }
    },
    sessionAuth: deferred(function(action, httpRequest) {
      var error, notify, reject, resolve;
      resolve = action.resolve, reject = action.reject, notify = action.notify;
      if (!authenticator.configured()) {
        error = new Error('dinkum absence of authenticator scheme');
        error.detail = {
          request: httpRequest.opts
        };
        httpRequest.promised.reject(error);
        action.reject();
        return;
      }
      if (authenticator.authenticating === 0) {
        queue.suspend = true;
        authenticator.authenticating = httpRequest.sequence;
        return authenticator.scheme.sessionAuth(action, httpRequest);
      } else {
        if (httpRequest.authenticator != null) {
          authenticator.authenticating = 0;
          authenticator.scheme.sessionAuth(action, httpRequest);
          return;
        }
        return queue.requeue(httpRequest).then(resolve, reject, notify);
      }
    })
  };
  if (config.authenticator != null) {
    authenticator.assign();
  }
  testable = authenticator;
  return api = {
    sessionAuth: authenticator.sessionAuth,
    requestAuth: authenticator.requestAuth,
    type: authenticator.type
  };
};
